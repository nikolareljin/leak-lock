name: Publish VS Code Extension

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [ main ]
    types: [ closed ]

  # default permissions remain minimal; elevate per-job

jobs:
  # Job to test the extension before publishing
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests in headless mode
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          xvfb-run -a -s '-screen 0 1024x768x24' npm test
        env:
          DISPLAY: ':99'
          CI: true

      - name: Run linter
        run: npm run lint
        continue-on-error: true # Don't fail pipeline on lint errors

  # Job to build and publish the extension
  publish:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'nikolareljin/leak-lock'
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for version calculation
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Mask tokens
        run: |
          echo "::add-mask::${{ secrets.GITHUB_TOKEN }}"
          echo "::add-mask::${{ secrets.VSCE_PAT }}"
          echo "::add-mask::${{ secrets.OVSX_PAT }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install VSCE (VS Code Extension Manager)
        run: |
          # Install specific compatible version of vsce
          npm install -g @vscode/vsce@latest
          # Verify installation and show available options
          echo "VSCE version:"
          vsce --version
          echo "VSCE help:"
          vsce package --help || echo "Help command failed, continuing..."
          # Install Open VSX CLI
          npm install -g ovsx@latest
          echo "OVSX version:"
          ovsx --version

      - name: Verify package.json structure
        run: |
          # Check that required fields are present
          node -e "
            const pkg = require('./package.json');
            console.log('Package name:', pkg.name);
            console.log('Version:', pkg.version);
            console.log('Publisher:', pkg.publisher);
            console.log('Engine requirement:', pkg.engines?.vscode);
            if (!pkg.name || !pkg.version || !pkg.publisher) {
              throw new Error('Missing required package.json fields');
            }
          "

      - name: Get current version
        id: version
        run: echo "version=$(node -p -e "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Check if version exists
        id: check_version
        run: |
          # Check if this version already exists as a git tag
          if git tag -l | grep -q "^v${{ steps.version.outputs.version }}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${{ steps.version.outputs.version }} already exists, skipping publish"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${{ steps.version.outputs.version }} is new, will publish"
          fi

      - name: Bump version
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Auto-bump patch version if current version already exists
          npm version patch --no-git-tag-version
          echo "version=$(node -p -e "require('./package.json').version")" >> $GITHUB_OUTPUT
        id: new_version

      - name: Package extension
        run: |
          # Set NODE_OPTIONS to handle potential memory issues
          export NODE_OPTIONS="--max-old-space-size=4096"

          # Remove test scripts and test samples.
          rm ./test*.*
          
          # Package the extension (removed --verbose flag as it's not supported)
          echo "Packaging extension..."
          vsce package
          
          # List created packages
          echo "Created packages:"
          ls -la *.vsix
        env:
          NODE_ENV: production

      - name: Validate package
        run: |
          # Verify the package was created successfully
          VSIX_FILE=$(ls *.vsix | head -1)
          if [ ! -f "$VSIX_FILE" ]; then
            echo "Error: No .vsix file found"
            exit 1
          fi
          
          echo "Package created successfully: $VSIX_FILE"
          echo "Package size: $(du -h "$VSIX_FILE" | cut -f1)"
          
          # Test package contents (list files in package)
          echo "Package contents:"
          vsce ls || echo "vsce ls command not available, skipping content listing"

      - name: Publish to VS Code Marketplace
        if: github.event_name == 'push'
        run: |
          # Set NODE_OPTIONS for publishing
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          # Check if PAT is available
          if [ -z "${{ secrets.VSCE_PAT }}" ]; then
            echo "Warning: VSCE_PAT secret not found, skipping marketplace publish"
            exit 0
          fi
          
          # Publish with retry logic (removed --verbose flag)
          for i in {1..3}; do
            echo "Publishing attempt $i..."
            if vsce publish --pat "${{ secrets.VSCE_PAT }}"; then
              echo "Published successfully!"
              break
            else
              echo "Publish attempt $i failed"
              if [ $i -lt 3 ]; then
                echo "Retrying in 30 seconds..."
                sleep 30
              else
                echo "All publish attempts failed"
                exit 1
              fi
            fi
          done
        env:
          NODE_ENV: production

      - name: Publish to Open VSX Registry
        if: github.event_name == 'push'
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          if [ -z "${{ secrets.OVSX_PAT }}" ]; then
            echo "Warning: OVSX_PAT secret not found, skipping Open VSX publish"
            exit 0
          fi
          VSIX_FILE=$(ls *.vsix | head -1)
          if [ ! -f "$VSIX_FILE" ]; then
            echo "Error: No .vsix file found"
            exit 1
          fi
          for i in {1..3}; do
            echo "Open VSX publish attempt $i..."
            if ovsx publish "$VSIX_FILE" -p "${{ secrets.OVSX_PAT }}"; then
              echo "Published to Open VSX successfully!"
              break
            else
              echo "Open VSX publish attempt $i failed"
              if [ $i -lt 3 ]; then
                echo "Retrying in 30 seconds..."
                sleep 30
              else
                echo "All Open VSX publish attempts failed"
                exit 1
              fi
            fi
          done
        env:
          NODE_ENV: production

      - name: Create Git Tag
        if: github.event_name == 'push'
        run: |
          FINAL_VERSION=${{ steps.new_version.outputs.version || steps.version.outputs.version }}
          echo "Creating git tag v${FINAL_VERSION}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag "v${FINAL_VERSION}"
          # Ensure remote is authenticated with GITHUB_TOKEN for pushing tags
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin "v${FINAL_VERSION}"

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.new_version.outputs.version || steps.version.outputs.version }}
          name: Release v${{ steps.new_version.outputs.version || steps.version.outputs.version }}
          body: |
            ## Changes in this Release
            
            ### üõ°Ô∏è Security Scanning
            - Enhanced dependency directory handling (node_modules, vendor, etc.)
            - Improved UI with sidebar controls and main area results
            - Dynamic progress indicators during scanning operations
            - Cross-platform security protection for Windows and Unix systems
            - Fixed XSS vulnerabilities in file path display
            - Enhanced path validation with directory traversal protection
            
            ### üîß Technical Improvements  
            - Separated installation/setup controls to sidebar
            - Streamlined main panel for scan results and BFG execution
            - Added spinner animations for better user feedback
            - Improved error handling and cleanup operations
            - Centralized configuration constants for better maintainability
            - Enhanced dependency installation with detailed instructions
            
            ### üöÄ Deployment
            - Automated publishing pipeline with version management
            - Comprehensive testing before release
            - Updated GitHub Actions to latest versions
            - Fixed Node.js compatibility issues with VSCE packaging
            - Resolved VSCE command line option compatibility
            
            **Installation:** Search for "leak-lock" in VS Code Extensions marketplace
            
            **Usage:** 
            1. Open the Leak Lock sidebar panel
            2. Install dependencies and select target directory  
            3. Click "Start Scan" to analyze for secrets
            4. Review results and run BFG cleanup as needed
          draft: false
          prerelease: false
          files: "*.vsix"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Extension Package
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: leak-lock-extension-v${{ steps.new_version.outputs.version || steps.version.outputs.version }}
          path: "*.vsix"
          retention-days: 30
          compression-level: 6
